/**
 * Core Philosophy: This ruleset implements a Role-Based Access Control (RBAC) model.
 * Admin privileges are granted via custom claims in the user's authentication token.
 * The default security posture is restrictive: data is private unless explicitly made public.
 *
 * Data Structure:
 * - /projects/{projectId}: Publicly readable data about real estate projects.
 * - /contact_messages/{contactMessageId}: Write-only for the public, readable only by admins.
 *
 * Key Security Decisions:
 * - Admin Access: A user is considered an admin if their auth token contains `token.isAdmin == true`.
 * - Public vs. Admin Content: Projects are public for reading but require admin rights for writing. Contact messages can be created by anyone but can only be read or managed by admins.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user has an admin role via custom claims.
     */
    function isAdmin() {
      return isSignedIn() && request.auth.token.isAdmin == true;
    }

    /**
     * Checks if a document exists. Used to protect against modifying or deleting
     * non-existent documents.
     */
    function isExistingDoc() {
      return resource != null;
    }

    /**
     * On create, validates that a document's internal 'id' field matches its document ID.
     * This enforces relational integrity from the client.
     */
    function isConsistentIdOnCreate(docId) {
      return request.resource.data.id == docId;
    }

    /**
     * On update, ensures the document's internal 'id' field cannot be changed.
     * This protects the primary relational key of the document.
     */
    function isIdImmutable() {
      return request.resource.data.id == resource.data.id;
    }


    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    /**
     * @description Controls access to real estate project data. All users can read, but only admins can write.
     */
    match /projects/{projectId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Manages contact form submissions. Anyone can create, only admins can read/delete.
     */
    match /contact_messages/{contactMessageId} {
      allow get, list, update, delete: if isAdmin();
      allow create: if true; // Anyone can submit a message
    }
  }
}
